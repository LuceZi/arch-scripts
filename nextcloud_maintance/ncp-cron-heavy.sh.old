#!/bin/bash

# NextcloudPi Heavy Cron Job
# This script performs heavy maintenance tasks for Nextcloud.
# It is intended to be run daily via cron.

LOGFILE="/var/log/ncp-cron.log"
NEXTCLOUD_OCC="/var/www/nextcloud/occ"

log() {
    echo "[`date '+%Y-%m-%d %H:%M:%S'`] $1" | tee -a "$LOGFILE"
}

log "==== Starting NextcloudPi Daily Maintenance ===="

# 1 案同步掃描
log "Starting files:scan --all..."
if sudo -u www-data php "$NEXTCLOUD_OCC" files:scan --all >> "$LOGFILE" 2>&1; then
    log "✅ File scan completed successfully."
else
    log "❌ File scan failed."
fi

# 2 預覽掃描（加入 preview 任務 queue）
log "Starting preview:pre-generate..."
if sudo -u www-data php "$NEXTCLOUD_OCC" preview:pre-generate >> "$LOGFILE" 2>&1; then
    log "✅ Preview pre-generation completed."
else
    log "❌ Preview pre-generation failed."
fi

log "==== All tasks completed ===="
